<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="app-container">
        <%- include('../partials/sidebar') %>

        <main class="main-content">
            <%- include('../partials/topbar') %>

            <div class="page-content">
                <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                    <div class="alert alert-success animate-fade-in">
                        <i data-lucide="check-circle"></i>
                        <p><%= success_msg %></p>
                    </div>
                <% } %>

                <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                    <div class="alert alert-error animate-fade-in">
                        <i data-lucide="alert-circle"></i>
                        <p><%= error_msg %></p>
                    </div>
                <% } %>

                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>
                            <i data-lucide="folder" style="color: var(--primary);"></i>
                            Study Materials
                        </h1>
                        <p>Upload and analyze your study materials with AI</p>
                    </div>
                    <div class="page-header-actions">
                        <a href="/materials/upload" class="btn btn-primary">
                            <i data-lucide="upload"></i>
                            Upload Material
                        </a>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid stats-grid-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i data-lucide="files"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value"><%= materials.length %></span>
                            <span class="stat-label">Total Files</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #14b8a6);">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value"><%= materials.filter(m => m.status === 'analyzed').length %></span>
                            <span class="stat-label">Analyzed</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #f97316);">
                            <i data-lucide="clock"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value"><%= materials.filter(m => m.status === 'pending').length %></span>
                            <span class="stat-label">Pending Analysis</span>
                        </div>
                    </div>
                </div>

                <!-- Materials List -->
                <% if (materials.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="folder-open"></i>
                        </div>
                        <h3>No Materials Yet</h3>
                        <p>Upload your study materials to get AI-powered analysis and topic extraction</p>
                        <a href="/materials/upload" class="btn btn-primary">
                            <i data-lucide="upload"></i>
                            Upload Your First Material
                        </a>
                    </div>
                <% } else { %>
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <i data-lucide="list"></i>
                                Your Materials
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="materials-list">
                                <% materials.forEach(material => { %>
                                    <div class="material-item">
                                        <div class="material-icon">
                                            <% if (material.mime_type?.includes('pdf')) { %>
                                                <i data-lucide="file-text" style="color: #dc2626;"></i>
                                            <% } else if (material.mime_type?.includes('image')) { %>
                                                <i data-lucide="image" style="color: #2563eb;"></i>
                                            <% } else if (material.mime_type?.includes('word') || material.original_filename?.endsWith('.doc') || material.original_filename?.endsWith('.docx')) { %>
                                                <i data-lucide="file-text" style="color: #2563eb;"></i>
                                            <% } else { %>
                                                <i data-lucide="file" style="color: var(--gray-500);"></i>
                                            <% } %>
                                        </div>
                                        
                                        <div class="material-info">
                                            <h4><%= material.original_filename %></h4>
                                            <div class="material-meta">
                                                <span>
                                                    <i data-lucide="hard-drive"></i>
                                                    <%= (material.file_size / 1024).toFixed(1) %> KB
                                                </span>
                                                <span>
                                                    <i data-lucide="calendar"></i>
                                                    <%= new Date(material.created_at).toLocaleDateString() %>
                                                </span>
                                                <% if (material.subject_name) { %>
                                                    <span class="subject-tag">
                                                        <i data-lucide="book"></i>
                                                        <%= material.subject_name %>
                                                    </span>
                                                <% } %>
                                            </div>
                                        </div>
                                        
                                        <div class="material-status">
                                            <% if (material.status === 'pending') { %>
                                                <span class="status-badge status-pending">
                                                    <i data-lucide="clock"></i>
                                                    Pending
                                                </span>
                                            <% } else if (material.status === 'processing') { %>
                                                <span class="status-badge status-processing">
                                                    <i data-lucide="loader"></i>
                                                    Processing
                                                </span>
                                            <% } else if (material.status === 'analyzed') { %>
                                                <span class="status-badge status-success">
                                                    <i data-lucide="check-circle"></i>
                                                    Analyzed
                                                </span>
                                            <% } else if (material.status === 'error') { %>
                                                <span class="status-badge status-error">
                                                    <i data-lucide="alert-circle"></i>
                                                    Error
                                                </span>
                                            <% } %>
                                        </div>
                                        
                                        <div class="material-actions">
                                            <a href="/materials/<%= material.id %>" class="btn btn-ghost btn-sm" title="View Details">
                                                <i data-lucide="eye"></i>
                                            </a>
                                            <% if (material.status === 'pending' || material.status === 'error') { %>
                                                <button class="btn btn-ghost btn-sm" onclick="analyzeMaterial(<%= material.id %>)" title="Analyze with AI">
                                                    <i data-lucide="sparkles"></i>
                                                </button>
                                            <% } %>
                                            <button class="btn btn-ghost btn-sm text-error" onclick="deleteMaterial(<%= material.id %>)" title="Delete">
                                                <i data-lucide="trash-2"></i>
                                            </button>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();

        // Analyze material with AI
        async function analyzeMaterial(id) {
            if (!confirm('Analyze this material with AI? This may take a moment.')) return;
            
            try {
                const response = await fetch(`/materials/analyze/${id}`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('Analysis complete!');
                    location.reload();
                } else {
                    alert(result.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            if (!confirm('Are you sure you want to delete this material?')) return;
            
            try {
                const response = await fetch(`/materials/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'Delete failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error');
            }
        }

        // Sidebar toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        if (menuToggle) {
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        }
    </script>

    <style>
        .materials-list {
            display: flex;
            flex-direction: column;
        }

        .material-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
            transition: background var(--transition-fast);
        }

        .material-item:hover {
            background: var(--gray-50);
        }

        .material-item:last-child {
            border-bottom: none;
        }

        .material-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .material-icon svg {
            width: 24px;
            height: 24px;
        }

        .material-info {
            flex: 1;
            min-width: 0;
        }

        .material-info h4 {
            margin: 0 0 var(--spacing-xs);
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .material-meta {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .material-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .material-meta svg {
            width: 14px;
            height: 14px;
        }

        .subject-tag {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }

        .material-status {
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge svg {
            width: 14px;
            height: 14px;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-processing {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-processing svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-success {
            background: #d1fae5;
            color: #059669;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .material-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .material-item {
                flex-wrap: wrap;
            }
            
            .material-info {
                width: calc(100% - 64px);
            }
            
            .material-status, .material-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</body>
</html>
