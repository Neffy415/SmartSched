<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .study-session-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: var(--spacing-xl);
            padding: var(--spacing-xl);
            min-height: calc(100vh - 80px);
        }

        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .timer-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .session-context { margin-bottom: var(--spacing-xl); }

        .session-subject-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--subject-color);
            color: white;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: var(--spacing-md);
        }

        .session-topic-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--spacing-sm);
        }

        .session-task-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
        }
        .session-task-badge svg { width: 16px; height: 16px; }

        .topic-progress-mini {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-md);
        }
        .topic-progress-mini .progress-circle {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: conic-gradient(var(--subject-color) calc(var(--progress) * 3.6deg), var(--gray-200) 0deg);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .topic-progress-mini .progress-circle::before {
            content: ''; position: absolute;
            width: 36px; height: 36px;
            background: white; border-radius: 50%;
        }
        .topic-progress-mini .progress-value {
            position: relative; font-size: 0.75rem;
            font-weight: 700; color: var(--gray-700);
        }
        .topic-progress-mini .progress-info { flex: 1; }
        .topic-progress-mini .progress-label { font-size: 0.75rem; color: var(--gray-500); }
        .topic-progress-mini .progress-stats { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); }

        .timer-display {
            background: white;
            border-radius: var(--radius-2xl);
            padding: 3rem;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-100);
        }
        .timer-time {
            font-size: 5rem; font-weight: 800;
            color: var(--gray-900);
            font-variant-numeric: tabular-nums;
            line-height: 1; letter-spacing: -0.02em;
        }
        .timer-time.overtime { color: var(--error); }
        .timer-label { font-size: 0.875rem; color: var(--gray-500); margin-top: 0.5rem; font-weight: 500; }
        .timer-planned { margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--gray-100); }
        .timer-planned-text { color: var(--gray-600); font-size: 0.875rem; margin-bottom: var(--spacing-sm); }
        .timer-progress { width: 100%; height: 10px; background: var(--gray-100); border-radius: var(--radius-full); overflow: hidden; }
        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-600));
            border-radius: var(--radius-full);
            transition: width 1s linear;
        }
        .timer-progress-bar.complete { background: var(--success); }
        .timer-progress-bar.overtime { background: var(--warning); }

        .timer-actions { display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; }
        .timer-actions .btn { min-width: 160px; }

        .stop-form { width: 100%; max-width: 500px; margin-top: var(--spacing-xl); }
        .stop-form .form-group { margin-bottom: var(--spacing-lg); text-align: left; }
        .quality-rating { display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; }
        .quality-rating input { display: none; }
        .quality-rating label {
            cursor: pointer; padding: 0.75rem 1rem;
            background: var(--gray-50); border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg); transition: all 0.2s;
            font-weight: 500; font-size: 0.875rem;
        }
        .quality-rating label:hover { border-color: var(--primary); background: var(--primary-50); }
        .quality-rating input:checked + label { background: var(--primary); border-color: var(--primary); color: white; }

        .study-sidebar { display: flex; flex-direction: column; gap: var(--spacing-lg); }
        .sidebar-panel {
            background: white; border-radius: var(--radius-xl);
            border: 1px solid var(--gray-100); overflow: hidden;
        }
        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--gray-50); border-bottom: 1px solid var(--gray-100);
        }
        .panel-title {
            display: flex; align-items: center; gap: var(--spacing-sm);
            font-weight: 600; font-size: 0.875rem; color: var(--gray-700);
        }
        .panel-title svg { width: 18px; height: 18px; color: var(--primary); }
        .panel-body { padding: var(--spacing-lg); }

        .quick-notes-textarea {
            width: 100%; min-height: 120px; padding: var(--spacing-md);
            border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
            font-size: 0.875rem; resize: vertical; font-family: inherit;
        }
        .quick-notes-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-100); }
        .quick-notes-actions { display: flex; justify-content: flex-end; margin-top: var(--spacing-sm); }
        .save-note-btn {
            padding: 0.5rem 1rem; background: var(--primary); color: white;
            border: none; border-radius: var(--radius-md); font-size: 0.8125rem;
            font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
        }
        .save-note-btn:hover { background: var(--primary-600); }
        .save-note-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .save-note-btn svg { width: 14px; height: 14px; }
        .note-saved-msg { color: var(--success); font-size: 0.75rem; margin-top: 0.5rem; display: none; }

        .saved-notes-list { display: flex; flex-direction: column; gap: var(--spacing-sm); max-height: 280px; overflow-y: auto; }
        .saved-note-item { padding: var(--spacing-md); background: var(--gray-50); border-radius: var(--radius-md); border-left: 3px solid var(--primary); cursor: pointer; transition: all var(--transition-fast); }
        .saved-note-item:hover { background: var(--primary-50); transform: translateX(4px); }
        .saved-note-title { font-weight: 600; font-size: 0.8125rem; color: var(--gray-800); margin-bottom: 0.25rem; }
        .saved-note-preview { font-size: 0.75rem; color: var(--gray-600); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .no-notes-msg { text-align: center; color: var(--gray-500); font-size: 0.8125rem; padding: var(--spacing-md); }
        .no-notes-msg svg { width: 32px; height: 32px; margin-bottom: var(--spacing-sm); opacity: 0.5; }

        .focus-mode-tip {
            display: flex; align-items: center; gap: var(--spacing-sm);
            padding: var(--spacing-md); background: var(--primary-50);
            border-radius: var(--radius-lg); color: var(--primary-700); font-size: 0.8125rem;
        }
        .focus-mode-tip svg { width: 18px; height: 18px; flex-shrink: 0; }

        @media (max-width: 1024px) {
            .study-session-layout { grid-template-columns: 1fr; }
            .study-sidebar { flex-direction: row; overflow-x: auto; }
            .sidebar-panel { min-width: 300px; }
        }
        @media (max-width: 640px) {
            .timer-time { font-size: 3.5rem; }
            .timer-display { padding: 2rem; }
            .study-sidebar { flex-direction: column; }
            .sidebar-panel { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <%- include('../partials/sidebar') %>
        <main class="main-content">
            <div class="study-session-layout" style="--subject-color: <%= session.subject_color %>; --progress: <%= topicProgress.percentage %>">
                <div class="timer-section">
                    <div class="timer-container">
                        <div class="session-context">
                            <div class="session-subject-badge">
                                <i data-lucide="book-open"></i>
                                <%= session.subject_name %>
                            </div>
                            <h1 class="session-topic-title"><%= session.topic_name %></h1>
                            <% if (session.task_title) { %>
                                <div class="session-task-badge">
                                    <i data-lucide="check-square"></i>
                                    <%= session.task_title %>
                                </div>
                            <% } %>
                            <div class="topic-progress-mini">
                                <div class="progress-circle">
                                    <span class="progress-value"><%= topicProgress.percentage %>%</span>
                                </div>
                                <div class="progress-info">
                                    <div class="progress-label">Topic Progress</div>
                                    <div class="progress-stats">
                                        <%= Math.round(topicProgress.totalMinutes / 60 * 10) / 10 %>h of <%= topicProgress.estimatedHours %>h studied
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="timer-display">
                            <div class="timer-time" id="timerDisplay">00:00:00</div>
                            <div class="timer-label">Time Elapsed</div>
                            <div class="timer-planned">
                                <div class="timer-planned-text">Planned: <%= session.planned_minutes %> minutes</div>
                                <div class="timer-progress">
                                    <div class="timer-progress-bar" id="progressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="timer-actions" id="runningActions">
                            <button type="button" class="btn btn-primary btn-lg" onclick="showStopForm()">
                                <i data-lucide="square"></i>
                                Stop Session
                            </button>
                            <form action="/study/cancel/<%= session.id %>" method="POST" style="display: inline;"
                                  onsubmit="return confirm('Cancel this session? Your time will not be saved.')">
                                <button type="submit" class="btn btn-secondary">
                                    <i data-lucide="x"></i>
                                    Cancel
                                </button>
                            </form>
                        </div>
                        <form action="/study/stop/<%= session.id %>" method="POST" class="stop-form" id="stopForm" style="display: none;">
                            <div class="form-group">
                                <label>How was your focus?</label>
                                <div class="quality-rating">
                                    <input type="radio" name="quality_rating" value="1" id="q1"><label for="q1">üò¥ Poor</label>
                                    <input type="radio" name="quality_rating" value="2" id="q2"><label for="q2">üòê Okay</label>
                                    <input type="radio" name="quality_rating" value="3" id="q3" checked><label for="q3">üôÇ Good</label>
                                    <input type="radio" name="quality_rating" value="4" id="q4"><label for="q4">üòä Great</label>
                                    <input type="radio" name="quality_rating" value="5" id="q5"><label for="q5">üî• Excellent</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="notes">Session Reflection (Optional)</label>
                                <textarea id="notes" name="notes" rows="3" placeholder="What did you accomplish?"></textarea>
                            </div>
                            <div class="timer-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideStopForm()">
                                    <i data-lucide="arrow-left"></i>
                                    Continue Studying
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i data-lucide="check"></i>
                                    Complete Session
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="study-sidebar">
                    <div class="sidebar-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i data-lucide="edit-3"></i>Quick Notes</div>
                        </div>
                        <div class="panel-body">
                            <textarea class="quick-notes-textarea" id="quickNotes" placeholder="Jot down quick thoughts while studying..."></textarea>
                            <div class="quick-notes-actions">
                                <button type="button" class="save-note-btn" id="saveNoteBtn" onclick="saveQuickNote()">
                                    <i data-lucide="save"></i>Save Note
                                </button>
                            </div>
                            <div class="note-saved-msg" id="noteSavedMsg"><i data-lucide="check-circle"></i> Note saved!</div>
                        </div>
                    </div>
                    <div class="sidebar-panel">
                        <div class="panel-header">
                            <div class="panel-title"><i data-lucide="file-text"></i>Topic Notes</div>
                            <a href="/notes?topic=<%= session.topic_id %>" class="btn btn-ghost btn-sm">View All</a>
                        </div>
                        <div class="panel-body">
                            <% if (savedNotes && savedNotes.length > 0) { %>
                                <div class="saved-notes-list">
                                    <% savedNotes.forEach(note => { %>
                                        <% 
                                            let preview = '';
                                            if (note.content) {
                                                // Strip HTML tags and get first 100 chars
                                                preview = note.content.replace(/<[^>]*>/g, '').substring(0, 100);
                                                if (note.content.length > 100) preview += '...';
                                            }
                                        %>
                                        <a href="/notes/<%= note.id %>" class="saved-note-item" style="text-decoration: none; color: inherit;">
                                            <div class="saved-note-title"><%= note.title %></div>
                                            <div class="saved-note-preview"><%= preview %></div>
                                        </a>
                                    <% }); %>
                                </div>
                            <% } else { %>
                                <div class="no-notes-msg">
                                    <i data-lucide="file-question"></i>
                                    <p>No saved notes for this topic yet.</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="focus-mode-tip">
                        <i data-lucide="lightbulb"></i>
                        <span>Pro tip: Minimize distractions. The timer keeps running in the background!</span>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        lucide.createIcons();
        const startTime = new Date('<%= session.start_time %>');
        const plannedMinutes = <%= session.planned_minutes %>;
        const sessionId = '<%= session.id %>';
        const timerDisplay = document.getElementById('timerDisplay');
        const progressBar = document.getElementById('progressBar');

        function updateTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            const elapsedMinutes = elapsed / 60;
            const progress = Math.min((elapsedMinutes / plannedMinutes) * 100, 100);
            progressBar.style.width = progress + '%';
            if (elapsedMinutes >= plannedMinutes) {
                progressBar.classList.add('complete');
                if (elapsedMinutes > plannedMinutes * 1.2) {
                    timerDisplay.classList.add('overtime');
                    progressBar.classList.remove('complete');
                    progressBar.classList.add('overtime');
                }
            }
            document.title = timerDisplay.textContent + ' - Study Session';
        }
        updateTimer();
        setInterval(updateTimer, 1000);

        function showStopForm() {
            document.getElementById('runningActions').style.display = 'none';
            document.getElementById('stopForm').style.display = 'block';
        }
        function hideStopForm() {
            document.getElementById('runningActions').style.display = 'flex';
            document.getElementById('stopForm').style.display = 'none';
        }

        async function saveQuickNote() {
            const noteText = document.getElementById('quickNotes').value.trim();
            const saveBtn = document.getElementById('saveNoteBtn');
            const savedMsg = document.getElementById('noteSavedMsg');
            if (!noteText) { alert('Please write something before saving.'); return; }
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader" class="spinning"></i> Saving...';
            lucide.createIcons();
            try {
                const response = await fetch(`/study/quick-note/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note: noteText })
                });
                const data = await response.json();
                if (data.success) {
                    savedMsg.style.display = 'block';
                    document.getElementById('quickNotes').value = '';
                    setTimeout(() => { savedMsg.style.display = 'none'; }, 3000);
                } else { alert('Failed to save note: ' + data.error); }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="save"></i> Save Note';
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>
